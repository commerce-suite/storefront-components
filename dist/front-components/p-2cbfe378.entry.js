import{r as t,c as i,h as s,H as o}from"./p-bc241129.js";import{P as e,L as n}from"./p-5d8d7e1b.js";import{e as r}from"./p-1f38ea7b.js";class l{async getProducts(){const t=this.liveShopData.products.map((t=>t.productId));return await e.getList({fields:["id","name","images { src }","price","priceCompare","productId","slug","hasPriceRange","balance","isSellOutOfStock","color { id, name, hexadecimal, slug, image { src } }"],filter:{productIds:t,page:0,first:1e3},agg:{field:["productId","colorId","id"]}})}async getLiveShop(t){this.liveShopData=await n.getByHash(t);return this.liveShopData}groupByProductIdWithColorAndVariations(t){var i,s;const o={};for(const{node:e}of t){const t=e.productId;const n=(s=(i=e.color)===null||i===void 0?void 0:i.id)!==null&&s!==void 0?s:0;if(!o[t])o[t]={};if(!o[t][n])o[t][n]=[];o[t][n].push(e)}return Object.fromEntries(Object.entries(o).map((([t,i])=>[+t,Object.values(i)])))}selectBaseNode(t){var i;return(i=t.find((t=>{var i;return(i=t.images)===null||i===void 0?void 0:i.length})))!==null&&i!==void 0?i:t[0]}buildProductItemGroupedByColor(t,i,s){var o,e,n;const r=i.filter((t=>{var i,s;return(s=(i=t[0])===null||i===void 0?void 0:i.color)===null||s===void 0?void 0:s.id}));const l=r.length>1;const a=l?r.map((t=>{var i,s,o,e,n,r,l,a;const h=t[0];return{id:(i=h.color)===null||i===void 0?void 0:i.id,name:(s=h.color)===null||s===void 0?void 0:s.name,slug:(o=h.color)===null||o===void 0?void 0:o.slug,hexadecimal:(e=h.color)===null||e===void 0?void 0:e.hexadecimal,image:((r=(n=h.color)===null||n===void 0?void 0:n.image)===null||r===void 0?void 0:r.src)?{src:h.color.image.src}:null,price:h.price,productImage:((a=(l=h.images)===null||l===void 0?void 0:l[0])===null||a===void 0?void 0:a.src)?{src:h.images[0].src}:null,balance:t.reduce(((t,i)=>{var s;return t+((s=i.balance)!==null&&s!==void 0?s:0)}),0),priceCompare:h.priceCompare,variations:t.map((t=>{var i,s;return{id:t.id,price:t.price,balance:t.balance,image:((s=(i=t.images)===null||i===void 0?void 0:i[0])===null||s===void 0?void 0:s.src)?{src:t.images[0].src}:null}}))}})):null;const h=t.color;const c=h?`${t.productId}-${h.id}`:`${t.productId}`;return Object.assign({id:+t.productId,name:t.name,image:((e=(o=t.images)===null||o===void 0?void 0:o[0])===null||e===void 0?void 0:e.src)?{src:t.images[0].src}:null,images:(()=>{var t;const s=new Set;const o=[];for(const e of i.flat()){const i=e.id;const n=(t=e.images)!==null&&t!==void 0?t:[];for(const t of n){if((t===null||t===void 0?void 0:t.src)&&!s.has(t.src)){s.add(t.src);o.push({src:t.src,variationId:i})}}}return o})(),price:t.price,priceBase:t.priceCompare,balance:t.balance,isSellOutOfStock:t.isSellOutOfStock,gridId:c,slug:t.slug,type:"product",show:(s===null||s===void 0?void 0:s.status)&&s.status!=="hidden",highlight:(s===null||s===void 0?void 0:s.status)==="highlighting",position:(n=s===null||s===void 0?void 0:s.position)!==null&&n!==void 0?n:0,colors:a},l?{}:{showStartingFrom:t.hasPriceRange})}async productsToItemsAdapter(){var t;const i=await this.getProducts();const s=(t=this.liveShopData)===null||t===void 0?void 0:t.products;const o=this.groupByProductIdWithColorAndVariations(i.edges);return Object.entries(o).map((([t,i])=>{const o=i.flat();const e=this.selectBaseNode(o);const n=s.find((i=>i.productId===Number(t)));return this.buildProductItemGroupedByColor(e,i,n)}))}messagesToItemsAdapter(){return this.liveShopData.messages.map((t=>{var i,s;return{id:(i=t.id)!==null&&i!==void 0?i:null,title:t.title,content:t.content,type:"message",show:t.status&&t.status!=="hidden",highlight:t.status==="highlighting",position:(s=t.position)!==null&&s!==void 0?s:0}}))}updateItems(t,i){const s=Math.max(...t.map((t=>{var i;return(i=t.position)!==null&&i!==void 0?i:0})));const o=t.map((t=>{var o,e;if(t.id!==i.id||t.type!==i.type)return t;const n=i.status==="highlighting";const r=!!t.highlight;const l=i.status==="hidden";if(n&&!r){return Object.assign(Object.assign({},t),{show:!l,highlight:true,lastPosition:(o=t.lastPosition)!==null&&o!==void 0?o:t.position,position:s+1})}if(!n&&r){return Object.assign(Object.assign({},t),{show:!l,highlight:false,position:(e=t.lastPosition)!==null&&e!==void 0?e:t.position,lastPosition:undefined})}return Object.assign(Object.assign({},t),{show:!l,highlight:n,position:s+1})}));o.sort(((t,i)=>{var s,o;return((s=i.position)!==null&&s!==void 0?s:0)-((o=t.position)!==null&&o!==void 0?o:0)}));return o}async getItems(){const t=await this.productsToItemsAdapter();const i=this.messagesToItemsAdapter();const s=[...t,...i];s.sort(((t,i)=>i.position-t.position));return s}}class a{constructor(t){this.socket=null;this.reconnectAttempts=0;this.reconnectTimeout=null;this.messageCallback=null;this.onOpen=()=>{this.reconnectAttempts=0;if(this.messageCallback&&this.socket){this.socket.addEventListener("message",this.messageCallback)}};this.onClose=t=>{if(!t.wasClean)this.handleReconnect()};this.onError=()=>{this.handleReconnect()};this.url=t;this.connect()}connect(){if(this.socket){this.socket.onclose=null;this.socket.onerror=null;this.socket.onmessage=null}this.socket=new WebSocket(this.url);this.socket.onopen=this.onOpen;this.socket.onclose=this.onClose;this.socket.onerror=this.onError}handleReconnect(){if(this.reconnectTimeout!==null)return;if(this.reconnectAttempts>=a.MAX_RECONNECT_ATTEMPTS)return;const t=this.reconnectAttempts===0?a.INITIAL_INCREMENT_DELAY:Math.min(a.INITIAL_RECONNECT_DELAY*Math.pow(2,this.reconnectAttempts-1),a.MAX_RECONNECT_DELAY);this.reconnectTimeout=window.setTimeout((()=>{this.reconnectAttempts++;this.reconnectTimeout=null;this.connect()}),t)}closeConnection(){var t;if(((t=this.socket)===null||t===void 0?void 0:t.readyState)===WebSocket.OPEN){this.socket.close()}if(this.reconnectTimeout!==null){clearTimeout(this.reconnectTimeout);this.reconnectTimeout=null}}onMessage(t){this.messageCallback=t;if(this.socket){this.socket.addEventListener("message",t)}}}a.MAX_RECONNECT_ATTEMPTS=5;a.INITIAL_RECONNECT_DELAY=5e3;a.MAX_RECONNECT_DELAY=3e4;a.INITIAL_INCREMENT_DELAY=1e3;const h='*{--fc-font-family:var(--m-ff);--fc-border-radius:4px;--fc-color-primary:var(--color-primary, #ff4295);--fc-color-secondary:var(--color-secondary, #000);--fc-color-white:var(--white, #fff);--fc-m-tt:var(--m-tt, "uppercase");--fc-m-fs:var(--m-fs, 14px);--fc-m-fw:var(--m-fw, 600);--fc-m-ls:var(--m-ls, 1px);--fc-h2-fs:var(--h2-fs, 18px);--fc-h2-fw:var(--h2-fw, 600);--fc-h2-ls:var(--h2-ls, 0px);--fc-color-light-text-default:#343a40;--fc-color-light-text-secondary:#6d747a;--fc-color-light-border-default:#dee2e6;--fc-gap-grid:24px;--fc-margin-width:8px}@keyframes lds-dual-ring-animation{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@keyframes simple-spinner-animation{0%{transform:translate(-50%, -50%) rotate(0deg)}100%{transform:translate(-50%, -50%) rotate(360deg)}}:host{display:block;width:100%}.loading-container{display:flex;width:100%;justify-content:center;align-items:center;min-height:350px}.loading-container .spinner{--spinner-color:var(--fc-color-secondary, #000);display:inline-block;width:80px;height:80px}.loading-container .spinner:after{content:" ";display:block;width:64px;height:64px;margin:8px;border-radius:50%;border:6px solid var(--spinner-color);border-color:var(--spinner-color) transparent var(--spinner-color) transparent;animation:lds-dual-ring-animation 1.2s linear infinite}.live-shop-warmup .banner-custom-style{padding:40px}.live-shop-warmup .banner-custom-style>.custom-card-content{width:100%;max-width:720px;height:auto;aspect-ratio:16/9}.live-shop-warmup .banner-custom-style>.custom-card-content img{width:100%;height:100%;object-fit:cover}.live-shop-warmup .banner-custom-style>.custom-card-content .live-shop-banner{background-color:#d9d9d9;height:100%;width:100%;display:flex;align-items:center;justify-content:center}.live-shop-finished .button-custom-style{padding:40px;max-width:410px;margin:0 auto;text-align:center}.live-shop-finished .button-custom-style button{--btn-bg-color:var(--fc-color-primary);--btn-text-color:var(--fc-color-white);--btn-text-weight:var(--fc-m-fw, 600);--btn-text-size:var(--fc-m-fs);--btn-text-transform:var(--fc-m-tt, "uppercase");--btn-text-letter-spacing:var(--fc-m-ls, 1px);all:unset;box-sizing:border-box;width:100%;background-color:var(--btn-bg-color);color:var(--btn-text-color);font-weight:var(--btn-text-weight);font-size:var(--btn-text-size);padding:12px 24px;cursor:pointer;border-radius:var(--fc-border-radius);text-align:center;text-transform:var(--btn-text-transform);letter-spacing:var(--btn-text-letter-spacing);font-weight:500;font-size:14px}.live-shop-finished .button-custom-style button:hover{opacity:0.75}.live-shop-finished .button-custom-style button:disabled{opacity:0.6;cursor:not-allowed}';const c=h;const d=class{constructor(s){t(this,s);this.onReturnToHome=i(this,"on-return-to-home",7);this.componentRendered=i(this,"componentRendered",7);this.handleResize=()=>{this.isSmallDevice=window.innerWidth<=1024};this.isChatOpenHandler=()=>{this.isChatOpen=!this.isChatOpen};this.handleMessage=t=>{try{if(!t.data)return;const i=JSON.parse(t.data);const s={liveOn:"inLive",liveOff:"finished"};if(s[i.type]){this.liveShopRegister=Object.assign(Object.assign({},this.liveShopRegister),{status:s[i.type]});return}this.liveShopItems=this.liveShopItemsService.updateItems(this.liveShopItems,i)}catch(t){console.error(t)}};this.hashRoom=undefined;this.liveShopNotFound=false;this.videoId=undefined;this.isSmallDevice=window.innerWidth<=1024;this.isChatOpen=false;this.isLoading=true;this.liveShopRegister=undefined;this.liveShopItemsService=undefined;this.liveShopItems=undefined;this.liveSocket=undefined}disconnectedCallback(){window.removeEventListener("resize",this.handleResize);if(this.liveSocket)this.liveSocket.closeConnection()}async componentDidLoad(){var t;try{if(!this.hashRoom)throw new Error("Hash Room is required");this.isLoading=true;window.addEventListener("resize",this.handleResize);this.componentRendered.emit();this.liveShopItemsService=new l;this.liveShopRegister=await this.liveShopItemsService.getLiveShop(this.hashRoom);if(!this.liveShopRegister)throw new Error("live-shop_not_found");this.liveShopItems=await this.liveShopItemsService.getItems();if(this.liveShopRegister){this.videoId=r(this.liveShopRegister.urlLive)}const t="ws://localhost:3001";this.liveSocket=new a(`${t}?hashRoom=${this.hashRoom}`);this.liveSocket.onMessage(this.handleMessage)}catch(i){if((t=i===null||i===void 0?void 0:i.message)===null||t===void 0?void 0:t.includes("live-shop_not_found")){this.liveShopNotFound=true;console.error("Live Shop not found",{error:i});return}console.error(i)}finally{this.isLoading=false}}renderLoading(){return s("div",{class:"loading-container"},s("span",{class:"spinner"}))}renderWarmup(){var t;return s("div",{class:"live-shop-warmup"},s("custom-card",{customClass:"banner-custom-style",cardTitle:this.liveShopRegister.title},((t=this.liveShopRegister.banner)===null||t===void 0?void 0:t.src)?s("img",{src:this.liveShopRegister.banner.src,alt:this.liveShopRegister.banner.alt}):null))}renderInLive(){return this.isSmallDevice?s("live-shop-mobile",{videoId:this.videoId,liveShopData:this.liveShopRegister,items:this.liveShopItems}):s("live-shop-desktop",{videoId:this.videoId,liveShopData:this.liveShopRegister,items:this.liveShopItems,isChatOpen:this.isChatOpen,toggleChat:()=>this.isChatOpenHandler()})}renderFinished(){return s("div",{class:"live-shop-finished"},s("custom-card",{customClass:"button-custom-style",cardTitle:"A live chegou ao fim!",cardDescription:"Fique de olho em nossas próximas lives para mais novidades!"},s("button",{onClick:()=>this.onReturnToHome.emit()},"Voltar para a página inicial")))}render(){var t,i,e;if(this.isLoading){return s(o,null,this.renderLoading())}if(this.liveShopNotFound){return s("live-shop-not-found",{onReturnToHome:()=>this.onReturnToHome.emit()})}return s(o,null,s("div",{class:"live-shop"},((t=this.liveShopRegister)===null||t===void 0?void 0:t.status)==="warmup"&&this.renderWarmup(),((i=this.liveShopRegister)===null||i===void 0?void 0:i.status)==="inLive"&&this.renderInLive(),((e=this.liveShopRegister)===null||e===void 0?void 0:e.status)==="finished"&&this.renderFinished()))}};d.style=c;export{d as live_shop};
//# sourceMappingURL=p-2cbfe378.entry.js.map