{"version":3,"names":["exec","method","url","data","Promise","resolve","reject","req","XMLHttpRequest","open","setRequestHeader","onload","status","JSON","parse","responseText","send","stringify","cashbackService","calculate","window","dooca","base_url","CalculationItemPromotion","cashbackCss","CashbackCreditStyle0","Cashback","componentWillLoad","this","getCalculation","onCustomerIdChange","onProductChange","valid","cashback","active","show_credit_preview","product","id","price","customer_id","exclude_promotions","CASHBACK_DEBIT","items","quantity","discount","res","byCredit","item","CASHBACK_CREDIT","promotion","credit","_a","find","render","h","Host","key","value","class","src","getAssetPath","currencyFormat"],"sources":["src/components/cashback/cashback.service.ts","src/components/cashback/cashback.type.ts","src/components/cashback/cashback.scss?tag=cashback-credit&encapsulation=scoped","src/components/cashback/cashback.tsx"],"sourcesContent":["import { Calculation, CalculationPayload } from './cashback.type';\n\nexport interface CashbackService {\n  calculate(data: CalculationPayload): Promise<Calculation>;\n}\n\nconst exec = (method: string, url: string, data?: Record<string, any>): Promise<any> => {\n  return new Promise((resolve, reject) => {\n    const req = new XMLHttpRequest();\n    req.open(method, url, true);\n    req.setRequestHeader('X-Ajax', 'true');\n    req.setRequestHeader('Content-Type', 'application/json');\n\n    req.onload = function () {\n      if (req.status >= 200 && req.status < 300) {\n        resolve(JSON.parse(req.responseText));\n      } else {\n        reject(req.status);\n      }\n    };\n\n    req.send(data ? JSON.stringify(data) : null);\n  });\n};\n\nexport const cashbackService: CashbackService = {\n  async calculate(data: CalculationPayload): Promise<Calculation> {\n    return await exec('POST', `${window.dooca.base_url}/action/promotions/calculate`, data);\n  },\n};\n","import { UUID } from 'crypto';\n\nexport interface ICashbackSettingRange {\n  min: number;\n  max: number;\n  markup: number;\n}\n\nexport interface ICashback {\n  id: UUID;\n  organization_id: number;\n  markup: number | string;\n  type: string;\n  release_days: number;\n  expiration_days: number;\n  exclude_categories?: number[] | null;\n  allowed_categories?: number[] | null;\n  allow_extra_discounts: boolean;\n  active: boolean;\n  active_to_use: boolean;\n  show_extract: boolean;\n  show_credit_preview: boolean;\n  max_representativeness?: number;\n  representativeness_type: string;\n  ranges?: ICashbackSettingRange[] | null;\n  created_at: string;\n  updated_at: string;\n}\n\nexport enum CalculationItemPromotion {\n  CASHBACK_CREDIT = 'cashback_credit',\n  CASHBACK_DEBIT = 'cashback_debit',\n}\n\nexport interface CalculationItem {\n  id: UUID;\n  promotion: CalculationItemPromotion;\n  value: number;\n  remaining_to_apply: number;\n  not_applicable_reasons: string[];\n}\n\nexport interface Calculation {\n  id: UUID;\n  customer_id?: number;\n  source: string;\n  source_id?: number;\n  check_sum: string;\n  items: CalculationItem[];\n}\n\nexport interface CalculationItemPayload {\n  id: number;\n  quantity: number;\n  price: number;\n  discount: number;\n}\n\nexport interface CalculationPayload {\n  customer_id: number | null;\n  exclude_promotions: CalculationItemPromotion[];\n  items: CalculationItemPayload[];\n}\n",".cashback {\n    display: inline-flex;\n\n    img {\n        margin-right: .5rem;\n    }\n\n    span {\n        color: var(--success);\n    }\n}","import {\n  Component,\n  ComponentWillLoad,\n  getAssetPath,\n  Host,\n  h,\n  Prop,\n  State,\n  Watch,\n} from '@stencil/core';\nimport { cashbackService } from './cashback.service';\nimport {\n  CalculationItem,\n  CalculationItemPromotion,\n  CalculationPayload,\n  ICashback,\n} from './cashback.type';\nimport { currencyFormat } from '../../utils/utils';\n\n@Component({\n  tag: 'cashback-credit',\n  styleUrl: 'cashback.scss',\n  scoped: true,\n})\nexport class Cashback implements ComponentWillLoad {\n  @Prop() customer_id: number | null;\n  @Prop() cashback: ICashback | null;\n  @Prop({ mutable: true }) product: { id: number; price: number };\n\n  @State() credit: CalculationItem;\n\n  async componentWillLoad(): Promise<void> {\n    await this.getCalculation();\n  }\n\n  @Watch('customer_id')\n  async onCustomerIdChange(): Promise<void> {\n    await this.getCalculation();\n  }\n\n  @Watch('product')\n  async onProductChange(): Promise<void> {\n    await this.getCalculation();\n  }\n\n  async getCalculation(): Promise<void> {\n    const valid = this.cashback && this.cashback.active && this.cashback.show_credit_preview;\n\n    if (!this.product || !valid) return;\n\n    const { id, price } = this.product;\n\n    const data: CalculationPayload = {\n      customer_id: this.customer_id,\n      exclude_promotions: [CalculationItemPromotion.CASHBACK_DEBIT],\n      items: [\n        {\n          id,\n          quantity: 1,\n          price,\n          discount: 0,\n        },\n      ],\n    };\n\n    const res = await cashbackService.calculate(data);\n\n    const byCredit = (item: CalculationItem) =>\n      CalculationItemPromotion.CASHBACK_CREDIT === item.promotion;\n    this.credit = res.items?.find(byCredit);\n  }\n\n  render() {\n    return (\n      <Host>\n        {this.credit && this.credit.value > 0 ? (\n          <div class=\"cashback\">\n            <img src={getAssetPath('./assets/icons/cashback.svg')} />\n            <span>\n              Na compra deste produto, você receberá até{' '}\n              <strong>{currencyFormat(this.credit.value)}</strong> em Cashback!\n            </span>\n          </div>\n        ) : null}\n      </Host>\n    );\n  }\n}\n"],"mappings":"6FAMA,MAAMA,EAAO,CAACC,EAAgBC,EAAaC,IAClC,IAAIC,SAAQ,CAACC,EAASC,KAC3B,MAAMC,EAAM,IAAIC,eAChBD,EAAIE,KAAKR,EAAQC,EAAK,MACtBK,EAAIG,iBAAiB,SAAU,QAC/BH,EAAIG,iBAAiB,eAAgB,oBAErCH,EAAII,OAAS,WACX,GAAIJ,EAAIK,QAAU,KAAOL,EAAIK,OAAS,IAAK,CACzCP,EAAQQ,KAAKC,MAAMP,EAAIQ,c,KAClB,CACLT,EAAOC,EAAIK,O,GAIfL,EAAIS,KAAKb,EAAOU,KAAKI,UAAUd,GAAQ,KAAK,IAIzC,MAAMe,EAAmC,CAC9C,eAAMC,CAAUhB,GACd,aAAaH,EAAK,OAAQ,GAAGoB,OAAOC,MAAMC,uCAAwCnB,E,GCEtF,IAAYoB,GAAZ,SAAYA,GACVA,EAAA,qCACAA,EAAA,kCACD,EAHD,CAAYA,MAAwB,KC7BpC,MAAMC,EAAc,sMACpB,MAAAC,EAAeD,E,MCuBFE,EAAQ,M,yHAOnB,uBAAMC,SACEC,KAAKC,gB,CAIb,wBAAMC,SACEF,KAAKC,gB,CAIb,qBAAME,SACEH,KAAKC,gB,CAGb,oBAAMA,G,MACJ,MAAMG,EAAQJ,KAAKK,UAAYL,KAAKK,SAASC,QAAUN,KAAKK,SAASE,oBAErE,IAAKP,KAAKQ,UAAYJ,EAAO,OAE7B,MAAMK,GAAEA,EAAEC,MAAEA,GAAUV,KAAKQ,QAE3B,MAAMjC,EAA2B,CAC/BoC,YAAaX,KAAKW,YAClBC,mBAAoB,CAACjB,EAAyBkB,gBAC9CC,MAAO,CACL,CACEL,KACAM,SAAU,EACVL,QACAM,SAAU,KAKhB,MAAMC,QAAY3B,EAAgBC,UAAUhB,GAE5C,MAAM2C,EAAYC,GAChBxB,EAAyByB,kBAAoBD,EAAKE,UACpDrB,KAAKsB,QAASC,EAAAN,EAAIH,SAAK,MAAAS,SAAA,SAAAA,EAAEC,KAAKN,E,CAGhC,MAAAO,GACE,OACEC,EAACC,EAAI,CAAAC,IAAA,4CACF5B,KAAKsB,QAAUtB,KAAKsB,OAAOO,MAAQ,EAClCH,EAAA,OAAKI,MAAM,YACTJ,EAAA,OAAKK,IAAKC,EAAa,iCACvBN,EAAA,yDAC6C,IAC3CA,EAAA,cAASO,EAAejC,KAAKsB,OAAOO,QAAgB,kBAGtD,K"}