{"version":3,"file":"live-shop.service.js","sourceRoot":"","sources":["../../../../src/components/live-shop/services/live-shop.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { LiveShopService, ProductService } from '@uxshop/storefront-core';\nimport { LiveShop } from '@uxshop/storefront-core/dist/modules/live-shop/LiveShopTypes';\nimport { IHighlightCardItem } from '../../../components';\nimport { IImage } from '../../ui/product-card/product-card.type';\nimport { IMessageItem, IProductItem } from '../../ui/highlight-card/highlight-card.type';\nimport { SocketMessage } from '../live-shop.type';\n\nexport class LiveShopHandler {\n  private liveShopData: LiveShop;\n\n  private async getProducts() {\n    const productIds = this.liveShopData.products.map(product => product.productId);\n    return await ProductService.getList({\n      fields: ['name', 'images { src }', 'price', 'priceCompare', 'productId', 'slug'],\n      filter: { productIds, page: 0, first: productIds.length },\n    });\n  }\n\n  async getLiveShop(hashRoom: string): Promise<LiveShop> {\n    this.liveShopData = await LiveShopService.getByHash(hashRoom);\n    return this.liveShopData;\n  }\n\n  async productsToItemsAdapter(): Promise<IProductItem[]> {\n    const products = await this.getProducts();\n    const liveProducts = this.liveShopData?.products;\n    return products.edges.map(({ node }) => {\n      const liveProduct = liveProducts.find(product => product.productId === node.productId);\n      const status = liveProduct?.status ?? null;\n      return {\n        id: +node.productId,\n        name: node.name,\n        image: (node?.images?.[0] as IImage) ?? null,\n        price: node.price,\n        priceBase: node.priceCompare,\n        title: '',\n        content: '',\n        type: 'product',\n        slug: node.slug,\n        show: status && status !== 'hidden',\n        highlight: status === 'highlighting',\n      };\n    });\n  }\n\n  messagesToItemsAdapter(): IMessageItem[] {\n    return this.liveShopData.messages.map(message => ({\n      id: message.id ?? null,\n      title: message.title,\n      content: message.content,\n      type: 'message',\n      show: message.status && message.status !== 'hidden',\n      highlight: message.status === 'highlighting',\n    }));\n  }\n\n  updateItems(items: IHighlightCardItem[], message: SocketMessage): IHighlightCardItem[] {\n    const updatedItems = items.map(item => {\n      if (item.id === message.id && item.type === message.type) {\n        return {\n          ...item,\n          show: message.status !== 'hidden',\n          highlight: message.status === 'highlighting',\n        };\n      }\n      return item;\n    });\n\n    return updatedItems;\n  }\n\n  async getItems(): Promise<IHighlightCardItem[]> {\n    const productItems = await this.productsToItemsAdapter();\n    const messageItems = this.messagesToItemsAdapter();\n    return [...productItems, ...messageItems];\n  }\n}\n"]}