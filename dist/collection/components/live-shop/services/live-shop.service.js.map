{"version":3,"file":"live-shop.service.js","sourceRoot":"","sources":["../../../../src/components/live-shop/services/live-shop.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { LiveShopService, ProductService } from '@uxshop/storefront-core';\nimport { LiveShop } from '@uxshop/storefront-core/dist/modules/live-shop/LiveShopTypes';\nimport { IHighlightCardItem } from '../../../components';\nimport { IImage } from '../../ui/product-card/product-card.type';\nimport { IMessageItem, IProductItem } from '../../ui/highlight-card/highlight-card.type';\nimport { SocketMessage } from '../live-shop.type';\n\nexport class LiveShopHandler {\n  private liveShopData: LiveShop;\n\n  private async getProducts() {\n    const productIds = this.liveShopData.products.map(product => product.productId);\n    return await ProductService.getList({\n      fields: [\n        'name',\n        'images { src }',\n        'price',\n        'priceCompare',\n        'productId',\n        'slug',\n        'hasPriceRange',\n      ],\n      filter: { productIds, page: 0, first: productIds.length },\n    });\n  }\n\n  async getLiveShop(hashRoom: string): Promise<LiveShop> {\n    this.liveShopData = await LiveShopService.getByHash(hashRoom);\n    return this.liveShopData;\n  }\n\n  async productsToItemsAdapter(): Promise<IProductItem[]> {\n    const products = await this.getProducts();\n    const liveProducts = this.liveShopData?.products;\n\n    return products.edges.map(({ node }) => {\n      const liveProduct = liveProducts.find(product => product.productId === node.productId);\n      const status = liveProduct?.status ?? null;\n      return {\n        id: +node.productId,\n        name: node.name,\n        image: (node?.images?.[0] as IImage) ?? null,\n        price: node.price,\n        priceBase: node.priceCompare,\n        title: '',\n        content: '',\n        type: 'product',\n        slug: node.slug,\n        show: status && status !== 'hidden',\n        highlight: status === 'highlighting',\n        position: liveProduct?.position ?? 0,\n        showStartingFrom: node.hasPriceRange,\n      };\n    });\n  }\n\n  messagesToItemsAdapter(): IMessageItem[] {\n    return this.liveShopData.messages.map(message => ({\n      id: message.id ?? null,\n      title: message.title,\n      content: message.content,\n      type: 'message',\n      show: message.status && message.status !== 'hidden',\n      highlight: message.status === 'highlighting',\n      position: message.position ?? 0,\n    }));\n  }\n\n  updateItems(items: IHighlightCardItem[], message: SocketMessage): IHighlightCardItem[] {\n    const maxPosition = Math.max(...items.map(i => i.position ?? 0));\n\n    const updatedItems = items.map(item => {\n      if (item.id !== message.id || item.type !== message.type) return item;\n\n      const isHighlightOn = message.status === 'highlighting';\n      const wasHighlightOn = !!item.highlight;\n      const isHidden = message.status === 'hidden';\n\n      if (isHighlightOn && !wasHighlightOn) {\n        return {\n          ...item,\n          show: !isHidden,\n          highlight: true,\n          lastPosition: item.lastPosition ?? item.position,\n          position: maxPosition + 1,\n        };\n      }\n\n      if (!isHighlightOn && wasHighlightOn) {\n        return {\n          ...item,\n          show: !isHidden,\n          highlight: false,\n          position: item.lastPosition ?? item.position,\n          lastPosition: undefined,\n        };\n      }\n\n      return {\n        ...item,\n        show: !isHidden,\n        highlight: isHighlightOn,\n        position: maxPosition + 1,\n      };\n    });\n\n    updatedItems.sort((a, b) => (b.position ?? 0) - (a.position ?? 0));\n    return updatedItems;\n  }\n\n  async getItems(): Promise<IHighlightCardItem[]> {\n    const productItems = await this.productsToItemsAdapter();\n    const messageItems = this.messagesToItemsAdapter();\n\n    const allItems = [...productItems, ...messageItems];\n\n    allItems.sort((a, b) => b.position - a.position);\n\n    return allItems;\n  }\n}\n"]}