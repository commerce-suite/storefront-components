{"version":3,"file":"front-buy-together.filter.js","sourceRoot":"","sources":["../../../../src/components/buy-together/services/front-buy-together.filter.ts"],"names":[],"mappings":"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","sourcesContent":["import { Product } from '@uxshop/storefront-core/dist/modules/buy-together/BuyTogetherTypes';\nimport { FrontBuyTogetherResponse } from './front-buy-together-response';\nimport { checkHasBalance, checkHasPrice, checkIsOutReleaseDate } from '../buy-together.utils';\n\ntype FilterRulesType = {\n  key: 'balance' | 'priceless' | 'releaseDate';\n  isActive: boolean;\n  applyFn: () => void;\n  checkFn: (data?: Partial<Product>) => boolean;\n};\n\nexport class FrontBuyTogetherFilter extends FrontBuyTogetherResponse {\n  private filterRules: FilterRulesType[] = [\n    {\n      key: 'balance',\n      isActive: true,\n      applyFn: this.filterByBalance.bind(this),\n      checkFn: checkHasBalance,\n    },\n    {\n      key: 'priceless',\n      isActive: true,\n      applyFn: this.filterByZeroPrice.bind(this),\n      checkFn: checkHasPrice,\n    },\n    {\n      key: 'releaseDate',\n      isActive: true,\n      applyFn: this.filterByReleaseDate.bind(this),\n      checkFn: checkIsOutReleaseDate,\n    },\n  ];\n\n  public applyFilters(overrideFilters?: Partial<FilterRulesType>[]) {\n    if (overrideFilters) {\n      this.filterRules = this.filterRules.map(filter => {\n        const overrideFilter = overrideFilters.find(({ key }) => key === filter.key);\n        if (!overrideFilter) return filter;\n\n        return {\n          ...filter,\n          ...overrideFilter,\n          applyFn: overrideFilter.applyFn ? overrideFilter.applyFn.bind(this) : filter.applyFn,\n        };\n      });\n    }\n    this.filterRules\n      .filter(({ isActive }) => isActive)\n      .forEach(({ applyFn }) => {\n        applyFn();\n      });\n    this.applyFilterVariations();\n    return this;\n  }\n\n  protected filterByZeroPrice() {\n    const shouldRemoveBuyTogether = !checkHasPrice(this.response.product);\n    if (!this.response || shouldRemoveBuyTogether) {\n      this.response = null;\n    }\n  }\n\n  protected filterByBalance() {\n    const productWithoutBalance = !checkHasBalance(this.response?.product);\n    const noneVariationsHasBalance = !this.response?.product.variations.some(checkHasBalance);\n    const shouldRemoveBuyTogether = productWithoutBalance || noneVariationsHasBalance;\n    if (!this.response || shouldRemoveBuyTogether) {\n      this.response = null;\n    }\n  }\n\n  protected filterByReleaseDate() {\n    const shouldRemoveBuyTogether = !checkIsOutReleaseDate(this.response?.product);\n    if (!this.response || shouldRemoveBuyTogether) {\n      this.response = null;\n    }\n  }\n\n  protected applyFilterVariations() {\n    if (!this.response) return;\n    const checkFns = this.filterRules\n      .filter(({ isActive }) => isActive)\n      .map(({ checkFn }) => checkFn);\n    this.response.productsPivot = this.response.productsPivot.filter(({ variations }) =>\n      this.filterVariations(variations, checkFns),\n    );\n  }\n\n  private filterVariations(\n    variations: Product[],\n    checkFns: ((data?: Partial<Product>) => boolean)[],\n  ) {\n    return (\n      variations.filter(data => {\n        const results = checkFns.map(fn => fn(data));\n        const shouldAdd = results.reduce((prev, current) => prev && current, true);\n        return shouldAdd;\n      }).length !== 0\n    );\n  }\n}\n"]}